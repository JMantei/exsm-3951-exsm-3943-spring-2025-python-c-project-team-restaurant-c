@model RestaurantManager.Models.Order
@using RestaurantManager.Enums

@{
    decimal subtotal = Model.OrderMenuItems?.Sum(item => item.Quantity * item.MenuItem.Price) ?? 0m;
    decimal tax = subtotal * 0.05m;
    decimal deliveryFee = Model.Type == OrderType.Delivery ? 5.00m : 0.00m;
    decimal tip = Model.TipAmount == 0 ? 0m : Model.TipAmount; // Ensure it's always 0 or a valid amount

    // REWARDS POINTS
    int userPoints = Model.User?.RewardsPoints ?? 0;
    bool canRedeem = userPoints >= 250;
    decimal rewardsDiscount = canRedeem ? 20.00m : 0m;

    decimal total = subtotal + tax + tip + deliveryFee - rewardsDiscount;

    decimal tip10 = Math.Round(subtotal * 0.10m, 2);
    decimal tip15 = Math.Round(subtotal * 0.15m, 2);
    decimal tip20 = Math.Round(subtotal * 0.20m, 2);
    bool isCustomTip = Model.TipAmount != 0 && Model.TipAmount != tip10 && Model.TipAmount != tip15 && Model.TipAmount !=
    tip20;
}

<!-- Right: Summary -->
<aside class="col-md-2 me-4 mb-4 sticky-sidebar d-flex flex-column"
    style="position: sticky; max-height: 40rem; width: 400px; background-color: white;">
    <div class="d-flex flex-column h-100">
        <h5 class="mb-4">Your Order</h5>

        <div class="d-flex justify-content-between mb-3">
            <span>Subtotal</span>
            <span>@subtotal.ToString("C2")</span>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <span>Tax (5%)</span>
            <span>@tax.ToString("C2")</span>
        </div>

        <div class="border-top pt-3 mt-3">
            <div class="d-flex justify-content-between mb-2">
                <span>Tip</span>
                <span id="tipDisplay">@Model.TipAmount.ToString("C2")</span>
            </div>

            <div class="btn-group w-100 mb-2" role="group" aria-label="Tip Options">
                <input type="radio" class="btn-check tip-option" name="TipAmount" id="tip10" value="@tip10"
                    @(Model.TipAmount == tip10 ? "checked" : "") autocomplete="off">
                <label class="btn btn-outline-primary" for="tip10">10%</label>

                <input type="radio" class="btn-check tip-option" name="TipAmount" id="tip15" value="@tip15"
                    @(Model.TipAmount == tip15 ? "checked" : "") autocomplete="off">
                <label class="btn btn-outline-primary" for="tip15">15%</label>

                <input type="radio" class="btn-check tip-option" name="TipAmount" id="tip20" value="@tip20"
                    @(Model.TipAmount == tip20 ? "checked" : "") autocomplete="off">
                <label class="btn btn-outline-primary" for="tip20">20%</label>

                <input type="radio" class="btn-check tip-option" name="TipAmount" id="tipOther" value="other"
                    @(isCustomTip ? "checked" : "") autocomplete="off">
                <label class="btn btn-outline-primary" for="tipOther">Other</label>
            </div>

            <input type="number" step="0.01" min="0" max="100000" name="CustomTipAmount" id="customTipInput"
                class="form-control mt-2" placeholder="Enter custom tip amount"
                value="@(isCustomTip? Model.TipAmount.ToString("F2") : "")" @(isCustomTip ? "" : "disabled") />
        </div>

        @if (Model.Type == OrderType.Delivery)
        {
            <div class="d-flex justify-content-between mt-4 mb-2">
                <span>Delivery Fee</span>
                <span>@deliveryFee.ToString("C2")</span>
            </div>
        }

        @if (rewardsDiscount > 0)
        {
            <div class="d-flex justify-content-between mt-4 mb-2">
                <span>Harvest Club Rewards</span>
                <span>@("-" + rewardsDiscount.ToString("C2"))</span>
            </div>
        }
        else if (!canRedeem)
        {
            <div class="text-muted small mt-3">
                You have @userPoints points. Earn 250 points to get a $20 discount on your next order.
            </div>
        }


    </div>


    <hr class="my-3" />

    <div class="d-flex justify-content-between fw-bold fs-5 mb-5">
        <span>Total</span>
        <span id="totalDisplay">@total.ToString("C2")</span>
    </div>

    @if (Model.OrderMenuItems != null && Model.OrderMenuItems.Any())
    {
        <form asp-controller="Order" asp-action="SubmitCheckout" method="post" class="mt-auto">
            <input type="hidden" name="selectedType" value="@Model.Type" />
            <input type="hidden" name="TipAmount" id="tipAmountInput" />
            <input type="hidden" name="CustomTipAmount" id="customTipAmountInput" />
            <input type="hidden" name="selectedAddressId" value="1" /> @* Update this dynamically *@
            <input type="hidden" name="deliveryDistanceKm" value="0" />
            <input type="hidden" name="redeemPoints" id="redeemPointsInput" value="true" />
            <button type="submit" class="btn btn-primary w-100">
                Place @RestaurantManager.Utilities.PropertyDisplayHelper.GetDisplayName(Model.Type) Order
            </button>
        </form>

    }
    </div>
</aside>



<script>
    const subtotal = parseFloat("@subtotal");
    const tax = parseFloat("@tax");
    const deliveryFee = parseFloat("@deliveryFee");
    const tipRadios = document.querySelectorAll('.tip-option');
    const customTipInput = document.getElementById('customTipInput');
    const tipDisplay = document.getElementById('tipDisplay');
    const totalDisplay = document.getElementById('totalDisplay');
    const rewardsDiscount = parseFloat("@rewardsDiscount");


    function updateTipAndTotal() {
        let tipAmount = 0;
        const selectedTip = document.querySelector('input[name="TipAmount"]:checked');
        const redeemCheckbox = document.getElementById('redeemCheckbox');
        const canRedeem = !redeemCheckbox.disabled;

        if (selectedTip) {
            tipAmount = selectedTip.value === "other" ? parseFloat(customTipInput.value) || 0 : parseFloat(selectedTip.value);
        }

        let rewardsDiscount = 0;
        if (canRedeem && redeemCheckbox.checked) {
            rewardsDiscount = 20.00;
        }

        tipDisplay.textContent = tipAmount.toLocaleString("en-US", { style: "currency", currency: "CAD" });

        let newTotal = subtotal + tax + deliveryFee + tipAmount - rewardsDiscount;
        if (newTotal < 0) newTotal = 0;

        totalDisplay.textContent = newTotal.toLocaleString("en-US", { style: "currency", currency: "CAD" });

        // Update hidden input for form submission
        document.getElementById('redeemPointsInput').value = redeemCheckbox.checked && canRedeem ? "true" : "false";
    }

    tipRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === "other") {
                customTipInput.disabled = false;
                customTipInput.focus();
            } else {
                customTipInput.disabled = true;
            }
            updateTipAndTotal();
        });
    });

    customTipInput.addEventListener('input', () => {
        document.getElementById('tipOther').checked = true;
        updateTipAndTotal();
    });

    document.addEventListener("DOMContentLoaded", function () {
        const tipOptions = document.querySelectorAll('input[name="TipAmount"]');
        const customTipInput = document.getElementById("customTipInput");

        function updateCustomTipVisibility() {
            const selected = document.querySelector('input[name="TipAmount"]:checked');
            if (selected && selected.id === "tipOther") {
                customTipInput.disabled = false;
                customTipInput.style.display = "block";
            } else {
                customTipInput.disabled = true;
                customTipInput.style.display = "none";
            }
        }

        tipOptions.forEach(option => {
            option.addEventListener("change", updateCustomTipVisibility);
        });

        // Initialize visibility on page load
        updateCustomTipVisibility();
    });

    // Initial update
    updateTipAndTotal();

    document.querySelector('form').addEventListener('submit', function (e) {
        const selected = document.querySelector('input[name="TipAmount"]:checked');
        let tipAmount = selected ? selected.value : "0";

        if (tipAmount === "other") {
            document.getElementById('customTipAmountInput').value = customTipInput.value;
        } else {
            document.getElementById('customTipAmountInput').value = "";
        }

        document.getElementById('tipAmountInput').value = tipAmount;
    });

</script>